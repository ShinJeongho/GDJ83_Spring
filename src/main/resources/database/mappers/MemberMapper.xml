<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.win.app.members.MemberDAO">

    <insert id="join" parameterType="com.win.app.members.MemberDTO">
        INSERT INTO MEMBERS (M_ID, MEMBER_NAME, MEMBER_NUMBER, PHONE, EMAIL, MEMBER_ID, MEMBER_PWD)
        VALUES (MEMBERS_SEQ.NEXTVAL, 
                #{member_name, jdbcType=VARCHAR}, 
                #{member_number, jdbcType=VARCHAR}, 
                #{phone, jdbcType=VARCHAR}, 
                #{email, jdbcType=VARCHAR}, 
                #{member_id, jdbcType=VARCHAR}, 
                #{member_pwd, jdbcType=VARCHAR})
    </insert>
    
    <select id="login" parameterType="com.win.app.members.MemberDTO" resultType="com.win.app.members.MemberDTO">
        SELECT 
            m.M_ID,
            m.MEMBER_ID,
            m.MEMBER_PWD,
            m.MEMBER_NAME
        FROM MEMBERS m
        WHERE m.MEMBER_ID = #{member_id, jdbcType=VARCHAR}
    </select>
    
    <select id="getMemberWithAccounts" parameterType="int" resultMap="memberWithAccountsResult">
        SELECT 
            m.M_ID,
            m.MEMBER_NAME,
            m.MEMBER_NUMBER,
            m.PHONE,
            m.EMAIL,
            m.MEMBER_ID,
            m.MEMBER_PWD,
            pi.PRODUCT_INFO_ID,
            pi.PRODUCT_ID,
            pi.JOIN_DATE,
            pi.ACCOUNT_NUMBER,
            pi.BALANCE
        FROM MEMBERS m
        LEFT JOIN PRODUCT_INFO pi ON m.M_ID = pi.M_ID
        WHERE m.M_ID = #{m_id, jdbcType=INTEGER}
    </select>
    
    <resultMap id="memberWithAccountsResult" type="com.win.app.members.MemberDTO">
        <id column="M_ID" property="m_id" jdbcType="INTEGER"/>
        <result column="MEMBER_NAME" property="member_name" jdbcType="VARCHAR"/>
        <result column="MEMBER_NUMBER" property="member_number" jdbcType="VARCHAR"/>
        <result column="PHONE" property="phone" jdbcType="VARCHAR"/>
        <result column="EMAIL" property="email" jdbcType="VARCHAR"/>
        <result column="MEMBER_ID" property="member_id" jdbcType="VARCHAR"/>
        <result column="MEMBER_PWD" property="member_pwd" jdbcType="VARCHAR"/>
        <collection property="dtos" ofType="com.win.app.accounts.AccountDTO">
            <id column="PRODUCT_INFO_ID" property="product_info_id" jdbcType="INTEGER"/>
            <result column="PRODUCT_ID" property="product_id" jdbcType="VARCHAR"/>
            <result column="JOIN_DATE" property="join_date" jdbcType="TIMESTAMP"/>
            <result column="ACCOUNT_NUMBER" property="account_number" jdbcType="VARCHAR"/>
            <result column="BALANCE" property="balance" jdbcType="DECIMAL"/>
        </collection>
    </resultMap>

    <select id="getMemberById" parameterType="int" resultType="com.win.app.members.MemberDTO">
        SELECT * FROM MEMBERS WHERE M_ID = #{m_id, jdbcType=INTEGER}
    </select>
    
    <update id="updateMember" parameterType="com.win.app.members.MemberDTO">
        UPDATE MEMBERS
        SET MEMBER_NAME = #{member_name, jdbcType=VARCHAR},
            MEMBER_NUMBER = #{member_number, jdbcType=VARCHAR},
            PHONE = #{phone, jdbcType=VARCHAR},
            EMAIL = #{email, jdbcType=VARCHAR}
        WHERE M_ID = #{m_id, jdbcType=INTEGER}
    </update>
    
    <delete id="deleteMember" parameterType="int">
        DELETE FROM MEMBERS WHERE M_ID = #{m_id, jdbcType=INTEGER}       
    </delete>
    
    <select id="detail" parameterType="int" resultType="com.win.app.members.MemberDTO">
        SELECT 
            m.M_ID,
            m.MEMBER_NAME,
            m.MEMBER_NUMBER,
            m.PHONE,
            m.EMAIL,
            m.MEMBER_ID,
            m.MEMBER_PWD,
            pi.PRODUCT_INFO_ID,
            pi.PRODUCT_ID,
            pi.JOIN_DATE,
            pi.ACCOUNT_NUMBER,
            pi.BALANCE
        FROM MEMBERS m
        LEFT JOIN PRODUCT_INFO pi ON m.M_ID = pi.M_ID
        WHERE m.M_ID = #{m_id, jdbcType=INTEGER}
    </select>
</mapper>
